FROM rust:1-bookworm AS dev
WORKDIR /app

RUN apt-get update \
    && apt-get install -y --no-install-recommends nodejs npm \
    && npm install -g @tailwindcss/cli \
    && rustup target add wasm32-unknown-unknown \
    && cargo install trunk \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

EXPOSE 8080

CMD ["sh", "-lc", "if [ -f package-lock.json ]; then npm ci --no-fund --no-audit; else npm install --no-fund --no-audit; fi && PATH=/usr/local/cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin /usr/local/cargo/bin/trunk serve --address 0.0.0.0 --port 8080 --poll"]
